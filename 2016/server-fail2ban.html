<!DOCTYPE html>
<html lang="da">
<head>
 <meta charset="utf-8">
 <title>'Server hardening' - Bloker u&oslash;nsket trafik med fail2ban
 | logiskhave</title>
 <meta name="description" content="Log ajourf&oslash;rt af Kresten Jacobsen.">
 <meta name="viewport" content="width=720">
 <link rel="icon" href="/static/favicon.ico">
 <link rel="apple-touch-icon" href="/static/apple-touch-icon.jpg"/>
 <link rel="stylesheet" href="/css/theme.css" type="text/css">
 <link rel="alternate" type="application/rss+xml" title="" href="/rss.xml">
</head>
<body>
    <div id="container">
        <div id="header">
            <h1><span>Jeg er</span> <a title="Kolofon" href="/colophon.html">Kresten Jacobsen.</a> <span>Dette er</span> <a title="Log" href="/"> min log.</a></h1>
        </div><!-- /header --><div class="post">
		<p class="date">04. juli, 2016</p>
    	<h2>
            
                'Server hardening' - Bloker u&oslash;nsket trafik med fail2ban

            
        </h2>
       	<p><a href="http://en.wikipedia.org/wiki/Wikipedia:Too_long;_didn't_read">TL;DR</a> - Jeg har et par servere snurrende rundt om i verdenen og ser derfor tydeligt, hvor ofte de bliver udsat for angreb. Her er mine noter til opsætning af fail2ban på en Ubuntu/Debian-box<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup>.</p>
<p><img alt="Serving" src="https://log.logiskhave.dk/static/20160126_server.jpg" title="Live to serve..." /></p>
<p>Fail2ban er en service, som holde øje med din servers logfiler og ændrer firewallregler baseret på, hvad fail2ban tror er uvedkomne forsøg på at tilgå maskinen. Som sådan er det uhyre effektivt til at blokere for forsøg på at få adgang til serveren via 'brute force'.</p>
<p>Før vi begynder at installere noget som helst på en Linux-maskine (via distroens repositories ihvertfald), bør man opdatere kildefilerne, så man sikrer at man får de nyeste pakker ned. Dette gøres med:</p>
<pre class="codehilite"><code>sudo apt-get update</code></pre>


<p>Hvorefter man gan installere fail2ban med:</p>
<pre class="codehilite"><code>sudo apt-get install fail2ban</code></pre>


<p>Den primære konfigurationsfil for fail2ban er <code>/etc/fail2ban/jail.conf</code>, men hvis vi retter i den rissikerer vi at en fremtidig opdatering af fail2ban ødelægger vores konfiguration. Derfor kopieres filen til en lokal fil, som vi bruger i stedet. Dette gøres med:</p>
<pre class="codehilite"><code>sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</code></pre>


<p>Og herefter kan den lokale fil redigeres, så den holder øje med nginx<sup id="fnref:nginx"><a class="footnote-ref" href="#fn:nginx" rel="footnote">2</a></sup>:</p>
<pre class="codehilite"><code>sudo nano /etc/fail2ban/jail.local</code></pre>


<p>Under direktivet <code>[nginx-http-auth]</code> sættes - ikke overraskende - <code>enabled = true</code>, for at aktivere den indbyggede nginx beskyttelse. Desværre har fail2ban ikke supermeget beskyttelse på nginx fronten og jeg foretrækker også at aktivere beskyttelse for ondsindet afvikling af scripts og onde robotter ved at indsætte nedenstående direktiver umiddelbart under <code>[nginx-http-auth]</code> direktivet:</p>
<pre class="codehilite"><code>[nginx-noscript]

enabled  = true
port     = http,https
filter   = nginx-noscript
logpath  = /var/log/nginx/access.log
maxretry = 6

[nginx-badbots]

enabled  = true
port     = http,https
filter   = nginx-badbots
logpath  = /var/log/nginx/access.log
maxretry = 2</code></pre>


<p>I de direktiver vi lige har sat op, er der referencer til nogle filtre. Disse skal vi naturligvis også have sat op. Gem derfor <code>/etc/fail2ban/jail.local</code> og skift til kataloget med filtrene:</p>
<pre class="codehilite"><code>cd /etc/fail2ban/filter.d</code></pre>


<p>I første omgang skal vi lige ændre et enkelt parameter i filtret til den medfølgende <code>[nginx-http-auth]</code> direktiv. Rediger derfor filen <code>nginx-http-auth.conf</code> med:</p>
<pre class="codehilite"><code>sudo nano nginx-http-auth.conf</code></pre>


<p>Indsæt regex'en <code>^ \[error\] \d+#\d+: \*\d+ no user/password was provided for basic authentication, client: &lt;HOST&gt;, server: \S+, request: "\S+ \S+ HTTP/\d+\.\d+", host: "\S+"\s*$</code> under den anden, gem og luk.</p>
<p>Herefter stjæler vi apache-direktivets badbot-filter, da det er ganske glimrende som det står, således:</p>
<pre class="codehilite"><code>sudo cp apache-badbots.conf nginx-badbots.conf</code></pre>


<p>Og endelig laver vi et filter til vores <code>[nginx-noscript]</code> direktiv:</p>
<pre class="codehilite"><code>sudo nano nginx-noscript.conf</code></pre>


<p>Og klippe-klisterer nedenstående ind i den tomme fil:</p>
<pre class="codehilite"><code>[Definition]

failregex = ^&lt;HOST&gt; -.*GET.*(\.php|\.asp|\.exe|\.pl|\.cgi|\.scgi)

ignoreregex =</code></pre>


<p>Og gemmer. Det er i øvrigt helt lovligt at sætte yderligere filendelser ind, men pas på du ikke blokerer for noget du skal bruge...</p>
<p>Til sidst skal det hele naturligvis (gen-)startes for at den nye konfiguration læses og aktiveres:</p>
<pre class="codehilite"><code>sudo service fail2ban restart</code></pre>


<p>Og endelig - efter det hele er gjort - kan man tjekke status på fail2ban med:</p>
<pre class="codehilite"><code>sudo fail2ban-client status</code></pre>


<p>Gør man som mig, finder man så lige ud af at man havde glemt et eller andet undervejs og kan begynde fejlsøgningen. :)</p>
<p><em>BONUS</em>: Vil man følge lidt med i hvad der bliver bannet, kan man bruge nedenstående kommandoer til at se, hvad der aktuelt er sat i skammekrogen.<sup id="fnref:skammekrog"><a class="footnote-ref" href="#fn:skammekrog" rel="footnote">3</a></sup></p>
<pre class="codehilite"><code>sudo fail2ban-client status nginx-http-auth
sudo fail2ban-client status nginx-noscript
sudo fail2ban-client status nginx-badbots
sudo fail2ban-client status ssh</code></pre>


<hr />
<p><em>Posts om server hardening:</em></p>
<ul>
<li><a href="/2016/server-opdater.html">Automatiske opdateringer</a></li>
<li><a href="/2016/server-ssh.html">Sikring af SSH</a></li>
<li><a href="/2016/server-firewall.html">Skærm af med en firewall</a></li>
<li><em>Kommer</em>: <a href="">Login med private keys</a></li>
<li><a href="/2016/server-fail2ban.html">Bloker uønsket trafik med fail2ban</a></li>
<li><em>Kommer</em>: ???</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Herefter bare Ubuntu; men det meste vil også gælde på Debian.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:nginx">
<p>Jeg bruger nginx, men hvis det er en anden service, der skal beskyttes, må du lige google den. SSH beskyttelse er sat op per default.&#160;<a class="footnote-backref" href="#fnref:nginx" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:skammekrog">
<p>Eller man kan sætte emailrapportering op. Men det må vente til en anden post.&#160;<a class="footnote-backref" href="#fnref:skammekrog" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </div>
	<div class="navleft">
		<a rel="prev prefetch" href="/archive.html">&lsaquo;&nbsp; Til arkivet</a>
	</div>

        <div id="footer">
            <p>Kresten Jacobsen @ logiskhave</p><p>Udgivet under <a href="//log.logiskhave.dk/static/solipsistisk_licens.html">Solipsistisk Offentlig Licens</a></p>
        </div><!-- /footer -->
    </div><!-- /container -->
</body>
</html>